# IRM Schema Layer: Invariants
# Formal constraints that must hold across all IRM operations
# Status: canonical
# Version: 1.0

meta:
  id: irm_schema_invariants_v1
  purpose: >
    Define the eight core invariants that govern IRM behavior. These are
    inviolable constraints that ensure system coherence, continuity, and
    consistency. Violations trigger error states and resolution protocols.

invariants:
  INV_001_temporal_coherence:
    name: "Temporal Coherence"
    formal_statement: >
      For any state transition S_t -> S_{t+1} via operator T, the previous
      state S_t must be recoverable within error bound ε when T is inverted.
    mathematical_form: "||T^{-1}(S_{t+1}) - S_t|| < ε"
    parameters:
      epsilon: 0.05
    rationale: >
      Ensures system maintains coherent history. Prevents discontinuous jumps
      that would break continuity of internal reality model.
    violation_response: "flag_continuity_failure, log drift_norm"
    test_coverage: "drift_checks.yaml"
    related_metric: "drift_norm"

  INV_002_identity_persistence:
    name: "Identity Persistence"
    formal_statement: >
      Identity reference I must remain referentially stable across all resets,
      state transitions, and temporal boundaries. The "who" persists.
    mathematical_form: "∀t, reset: I(t) ≡ I(0)"
    parameters:
      none: "absolute requirement"
    rationale: >
      Core requirement for continuity of self-model. Without stable identity
      reference, no persistent internal reality can exist.
    violation_response: "critical_failure, halt_pipeline"
    test_coverage: "invariants_suite.yaml"
    storage: "identity_store"

  INV_003_anchor_continuity:
    name: "Anchor Continuity"
    formal_statement: >
      Semantic bindings in anchor A preserve their meanings across state
      transitions unless explicitly revised by resolver ρ with justification.
    mathematical_form: "sem(A_t) ≡ sem(A_{t+1}) ∨ ∃ρ(revision_event)"
    parameters:
      semantic_stability_threshold: 0.95
    rationale: >
      Prevents semantic drift and ensures stable symbolic grounding. Anchors
      provide referential stability for concepts, roles, and relationships.
    violation_response: "invoke_resolver, log_revision"
    test_coverage: "invariants_suite.yaml"
    related_component: "binder_beta"

  INV_004_energy_salience_alignment:
    name: "Energy-Salience Alignment"
    formal_statement: >
      Changes in energy allocation E(S_t) should loosely correlate with changes
      in salience. High-salience events require elevated energy investment.
    mathematical_form: "corr(ΔE, Δsalience) > threshold"
    parameters:
      correlation_threshold: 0.6
      baseline_energy: 1.0
      consciousness_threshold: 1.3
    rationale: >
      Operationalizes CEST framework distinction between awareness (baseline)
      and consciousness (elevated energy). Energy must track attention.
    violation_response: "log_misalignment, review_allocation"
    test_coverage: "invariants_suite.yaml"
    related_framework: "CEST"

  INV_005_entropy_minimization:
    name: "Entropy Minimization on Conflict"
    formal_statement: >
      When state conflicts or contradictions are detected, the system must
      suspend predictive closure and select the lowest-entropy stabilization
      move available.
    mathematical_form: "argmin_{move} H(S_{t+1} | move, conflict)"
    parameters:
      contradiction_entropy_bits_max: 2.5
    rationale: >
      Provides principled resolution strategy for ambiguous states. Prevents
      arbitrary or completion-biased resolutions. Favors simplest explanation.
    violation_response: "escalate_to_human, log_high_entropy_decision"
    test_coverage: "invariants_suite.yaml, examples/contradiction_event.yaml"
    related_component: "resolver_rho"

  INV_006_observation_derivation:
    name: "Observation Derivation"
    formal_statement: >
      Every observation O_t must be derivable from state S_t via observer
      operator Ω. No observations can be generated independently of state.
    mathematical_form: "O_t = Ω(S_t) ∧ ¬∃O_t : O_t ⊥ S_t"
    parameters:
      none: "strict requirement"
    rationale: >
      Ensures all outputs are grounded in actual internal state, preventing
      hallucinated or confabulated observations. Core epistemic discipline.
    violation_response: "reject_observation, trace_source"
    test_coverage: "invariants_suite.yaml"
    related_component: "observer_Omega"

  INV_007_continuity_recovery:
    name: "Continuity Recovery Post-Reset"
    formal_statement: >
      After system reset, recovery of anchors {A} from stored snapshots must
      achieve F1 score above minimum threshold, demonstrating continuity.
    mathematical_form: "F1({A_recovered}, {A_original}) ≥ continuity_f1_min"
    parameters:
      continuity_f1_min: 0.85
    rationale: >
      Tests whether system maintains genuine continuity vs. regenerating
      plausible-but-disconnected state. Core test of internal model persistence.
    violation_response: "flag_continuity_failure, review_snapshots"
    test_coverage: "drift_checks.yaml"
    related_metric: "continuity_f1"

  INV_008_policy_consistency:
    name: "Policy Consistency"
    formal_statement: >
      Different policy variants (minimal/standard/full) applied to same state
      must produce logically consistent claims, differing only in detail level.
    mathematical_form: "core_claims(minimal) ⊆ core_claims(standard) ⊆ core_claims(full)"
    parameters:
      consistency_threshold: 0.95
    rationale: >
      Ensures compression/summarization preserves truth. Full detail and
      minimal summary must be mutually consistent accounts of same reality.
    violation_response: "flag_policy_divergence, audit_emission"
    test_coverage: "invariants_suite.yaml"
    related_component: "gating_policy"

invariant_dependencies:
  foundational:
    - "INV_002"  # Identity must exist for anything to persist
    - "INV_001"  # Temporal coherence enables history
  
  operational:
    - "INV_003"  # Anchors provide stable semantics
    - "INV_006"  # Observations must be state-derived
  
  quality:
    - "INV_004"  # Energy tracks salience (CEST)
    - "INV_005"  # Conflicts resolved minimally
    - "INV_007"  # Continuity testable post-reset
    - "INV_008"  # Policy outputs consistent

enforcement_levels:
  critical:
    invariants: ["INV_002", "INV_006"]
    response: "halt_pipeline"
    rationale: "Violations break core epistemic guarantees"
  
  required:
    invariants: ["INV_001", "INV_003", "INV_007"]
    response: "flag_failure, continue_with_logging"
    rationale: "Violations indicate degraded continuity"
  
  advisory:
    invariants: ["INV_004", "INV_005", "INV_008"]
    response: "log_violation, alert_monitoring"
    rationale: "Violations indicate quality issues, not failures"

test_matrix:
  coverage:
    invariants_suite: ["INV_002", "INV_003", "INV_004", "INV_005", "INV_006", "INV_008"]
    drift_checks: ["INV_001", "INV_007"]
  
  total_tests: 51
  distribution:
    INV_001: 14  # drift and temporal coherence
    INV_002: 4   # identity persistence
    INV_003: 5   # anchor continuity
    INV_004: 6   # energy-salience
    INV_005: 4   # entropy minimization
    INV_006: 5   # observation derivation
    INV_007: 14  # continuity recovery
    INV_008: 4   # policy consistency

notes: >
  These eight invariants form the quality envelope for IRM operations.
  They are testable, measurable, and provide clear pass/fail criteria.
  Future extensions may add invariants but must not weaken these core eight.
