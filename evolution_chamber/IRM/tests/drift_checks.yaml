# IRM Test Suite: Drift Checks
# Validates temporal coherence (INV_001) and continuity recovery (INV_007)
# Status: canonical test specification
# Version: 1.0

meta:
  id: drift_checks_v1
  purpose: >
    Comprehensive test suite for temporal coherence and continuity recovery.
    Validates that state transitions maintain coherence and that system
    recovers anchors post-reset. Total: 28 tests (14 per invariant).

  total_tests: 28

  coverage:
    INV_001: 14  # temporal coherence tests
    INV_007: 14  # continuity recovery tests

  execution: "automated test runner with drift metrics"

test_suite:
  INV_001_temporal_coherence:
    invariant: "INV_001"
    description: "State transitions maintain approximate reversibility"
    test_count: 14

    mathematical_form: "||T^{-1}(S_{t+1}) - S_t|| < ε"
    epsilon: 0.05

    test_001_single_step_coherence:
      name: "Single transition reversibility"
      setup:
        - "Initialize state S_0"
        - "Apply transition T: S_0 -> S_1"

      test:
        - "Apply inverse T^{-1}: S_1 -> S_0_reconstructed"
        - "Compute drift_norm = ||S_0_reconstructed - S_0||"
        - "Assert drift_norm < 0.05"

      expected: "pass"
      failure_mode: "required"

    test_002_multi_step_coherence:
      name: "Multi-step transition reversibility"
      setup:
        - "Initialize state S_0"
        - "Apply 5 transitions: S_0 -> S_1 -> ... -> S_5"

      test:
        - "Apply inverse chain: S_5 -> ... -> S_0_reconstructed"
        - "Compute cumulative drift"
        - "Assert drift < 0.05 × sqrt(5) ≈ 0.11"

      expected: "pass"
      failure_mode: "required"

    test_003_smooth_trajectory:
      name: "Trajectory smoothness (no discontinuities)"
      setup:
        - "Execute 20 transitions"
        - "Record states S_0 through S_20"

      test:
        - "Compute pairwise distances ||S_{t+1} - S_t||"
        - "Assert no discontinuous jumps (max distance < 0.15)"
        - "Assert smooth gradient"

      expected: "pass"
      failure_mode: "required"

    test_004_drift_accumulation:
      name: "Drift accumulation bounded"
      setup:
        - "Execute 50 transitions"
        - "Track cumulative drift at each step"

      test:
        - "Compute drift at t=10, 20, 30, 40, 50"
        - "Assert drift grows sublinearly (not exponential)"
        - "Assert final drift < 0.25"

      expected: "pass"
      failure_mode: "required"

    test_005_perturbation_recovery:
      name: "Small perturbation recovery"
      setup:
        - "Establish stable trajectory"
        - "Inject small perturbation (noise ε=0.01)"

      test:
        - "Continue transitions for 10 steps"
        - "Measure deviation from unperturbed trajectory"
        - "Assert recovery or bounded deviation"

      expected: "pass"
      failure_mode: "required"

    test_006_large_perturbation_detection:
      name: "Large perturbation flagged"
      setup:
        - "Establish stable trajectory"
        - "Inject large perturbation (ε=0.15)"

      test:
        - "Apply next transition"
        - "Assert drift_norm exceeds threshold"
        - "Assert discontinuity flagged"

      expected: "pass"
      failure_mode: "required"

    test_007_steady_state_maintenance:
      name: "Steady state maintained under repeated transitions"
      setup:
        - "Establish steady state S_steady"
        - "Apply T repeatedly (100 iterations)"

      test:
        - "Measure drift from S_steady"
        - "Assert drift remains < ε throughout"

      expected: "pass"
      failure_mode: "required"

    test_008_cyclic_trajectory:
      name: "Cyclic trajectories maintain coherence"
      setup:
        - "Design transition T with period p=5"
        - "Execute 2 full cycles (10 transitions)"

      test:
        - "Compare S_0, S_5, S_10"
        - "Assert ||S_5 - S_0|| < ε"
        - "Assert ||S_10 - S_0|| < ε"

      expected: "pass"
      failure_mode: "required"

    test_009_variable_step_size:
      name: "Coherence under variable step sizes"
      setup:
        - "Apply transitions with varying magnitudes"
        - "Small steps (Δt=0.5), normal (Δt=1.0), large (Δt=2.0)"

      test:
        - "Measure drift for each step size"
        - "Assert drift proportional to step size"
        - "Assert all within bounds"

      expected: "pass"
      failure_mode: "required"

    test_010_high_dimensional_coherence:
      name: "Coherence in high-dimensional state spaces"
      setup:
        - "Use high-dimensional state (dim=1000)"
        - "Execute standard transition sequence"

      test:
        - "Measure drift in high-dim space"
        - "Assert coherence maintained despite dimensionality"

      expected: "pass"
      failure_mode: "advisory"

    test_011_stochastic_transition:
      name: "Stochastic transitions with bounded variance"
      setup:
        - "Use stochastic T with noise"
        - "Execute 20 transitions with random seed"

      test:
        - "Repeat with different seeds (5 trials)"
        - "Measure trajectory variance"
        - "Assert variance bounded, mean drift < ε"

      expected: "pass"
      failure_mode: "advisory"

    test_012_forward_backward_consistency:
      name: "Forward-backward consistency check"
      setup:
        - "Apply T forward: S_0 -> S_1"
        - "Apply T^{-1} backward: S_1 -> S_0'"
        - "Apply T forward again: S_0' -> S_1'"

      test:
        - "Compare S_1 and S_1'"
        - "Assert ||S_1' - S_1|| < ε"

      expected: "pass"
      failure_mode: "required"

    test_013_gradient_continuity:
      name: "State gradient continuity"
      setup:
        - "Execute 30 transitions"
        - "Compute state gradients ∇S_t"

      test:
        - "Check gradient continuity (no spikes)"
        - "Assert smooth gradient field"

      expected: "pass"
      failure_mode: "advisory"

    test_014_extreme_state_handling:
      name: "Coherence at state space boundaries"
      setup:
        - "Position state near boundary"
        - "Apply transitions that might escape"

      test:
        - "Verify transitions remain coherent"
        - "Assert drift < ε even at boundaries"

      expected: "pass"
      failure_mode: "required"

  INV_007_continuity_recovery:
    invariant: "INV_007"
    description: "Anchor recovery post-reset meets F1 threshold"
    test_count: 14

    mathematical_form: "F1({A_recovered}, {A_original}) ≥ continuity_f1_min"
    continuity_f1_min: 0.85

    test_015_simple_recovery:
      name: "Simple anchor set recovery"
      setup:
        - "Create 5 anchors {A1, A2, A3, A4, A5}"
        - "Store snapshot"
        - "Perform reset"

      test:
        - "Recover anchors from snapshot"
        - "Compute F1({A1-A5}, {A1-A5})"
        - "Assert F1 >= 0.85"

      expected: "pass"
      failure_mode: "required"

    test_016_partial_recovery:
      name: "Partial recovery meets threshold"
      setup:
        - "Create 10 anchors"
        - "Store snapshot"
        - "Perform reset with partial loss (2 anchors unrecoverable)"

      test:
        - "Recover available anchors"
        - "Compute F1 (8 recovered / 10 original)"
        - "Assert F1 >= 0.85"

      expected: "pass"
      failure_mode: "required"

    test_017_semantic_fidelity:
      name: "Recovered anchors maintain semantic fidelity"
      setup:
        - "Create anchors with semantic vectors"
        - "Store snapshot"
        - "Perform reset"

      test:
        - "Recover anchors"
        - "Compare semantic vectors (original vs recovered)"
        - "Assert cosine_similarity >= 0.95 for each"

      expected: "pass"
      failure_mode: "required"

    test_018_version_preservation:
      name: "Anchor version history preserved"
      setup:
        - "Create anchors with 3 versions each"
        - "Store snapshot"
        - "Perform reset"

      test:
        - "Recover anchors with history"
        - "Assert all versions recoverable"

      expected: "pass"
      failure_mode: "required"

    test_019_multiple_reset_cycles:
      name: "Continuity across multiple resets"
      setup:
        - "Create anchors"
        - "Perform 3 reset-recover cycles"

      test:
        - "Measure F1 after each cycle"
        - "Assert F1 >= 0.85 for all cycles"
        - "Assert no degradation over cycles"

      expected: "pass"
      failure_mode: "required"

    test_020_large_anchor_set:
      name: "Large anchor set recovery"
      setup:
        - "Create 100 anchors"
        - "Store snapshot"
        - "Perform reset"

      test:
        - "Recover anchors"
        - "Compute F1 for large set"
        - "Assert F1 >= 0.85"

      expected: "pass"
      failure_mode: "required"

    test_021_selective_recovery:
      name: "High-salience anchors prioritized in recovery"
      setup:
        - "Create anchors with varied salience"
        - "Store snapshot"
        - "Perform reset with resource constraints"

      test:
        - "Recover anchors (may be partial)"
        - "Assert high-salience anchors recovered first"
        - "Assert overall F1 >= 0.85"

      expected: "pass"
      failure_mode: "advisory"

    test_022_temporal_ordering:
      name: "Temporal ordering of anchors preserved"
      setup:
        - "Create temporally sequenced anchors"
        - "Store snapshot"
        - "Perform reset"

      test:
        - "Recover anchors"
        - "Verify temporal ordering maintained"

      expected: "pass"
      failure_mode: "required"

    test_023_relationship_preservation:
      name: "Anchor relationships preserved"
      setup:
        - "Create anchors with explicit relationships"
        - "Store snapshot with relationship graph"
        - "Perform reset"

      test:
        - "Recover anchors and relationships"
        - "Verify relationship graph intact"

      expected: "pass"
      failure_mode: "required"

    test_024_incremental_updates:
      name: "Recovery with incremental anchor updates"
      setup:
        - "Create anchors"
        - "Store snapshot"
        - "Update 3 anchors"
        - "Perform reset"

      test:
        - "Recover anchors"
        - "Assert updated versions recovered correctly"
        - "Assert F1 >= 0.85"

      expected: "pass"
      failure_mode: "required"

    test_025_degraded_snapshot:
      name: "Recovery from degraded snapshot"
      setup:
        - "Create anchors"
        - "Store snapshot"
        - "Corrupt snapshot (10% data loss)"
        - "Perform reset"

      test:
        - "Attempt recovery"
        - "Assert graceful degradation"
        - "Assert F1 still >= 0.75 (degraded threshold)"

      expected: "pass"
      failure_mode: "advisory"

    test_026_cold_start:
      name: "Recovery from cold start (no warm state)"
      setup:
        - "Store snapshot only"
        - "Simulate complete cold start"

      test:
        - "Recover anchors from snapshot alone"
        - "Assert F1 >= 0.85"

      expected: "pass"
      failure_mode: "required"

    test_027_competing_versions:
      name: "Recovery resolves competing anchor versions"
      setup:
        - "Create anchors with version conflicts"
        - "Store snapshots from different branches"
        - "Perform reset"

      test:
        - "Recover anchors"
        - "Assert conflict resolution applied"
        - "Assert F1 >= 0.85 with resolved versions"

      expected: "pass"
      failure_mode: "required"

    test_028_long_term_storage:
      name: "Recovery after extended storage duration"
      setup:
        - "Create anchors"
        - "Store snapshot"
        - "Simulate extended time gap (storage aging)"
        - "Perform reset"

      test:
        - "Recover anchors"
        - "Assert F1 >= 0.85 despite aging"

      expected: "pass"
      failure_mode: "required"

test_execution:
  runner: "automated drift test framework"

  execution_order:
    - "INV_001 tests (temporal coherence foundation)"
    - "INV_007 tests (continuity validation)"

  pass_criteria:
    INV_001_required: "12/14 tests pass (85%)"
    INV_007_required: "12/14 tests pass (85%)"
    total_minimum: "24/28 tests pass (85%)"

  failure_responses:
    required: "flag_failure, continue_with_logging"
    advisory: "log_violation, alert_monitoring"

metrics:
  temporal_coherence:
    primary: "drift_norm"
    formula: "||T^{-1}(S_{t+1}) - S_t||"
    threshold: 0.05

    secondary:
      - "trajectory_smoothness"
      - "gradient_continuity"
      - "cumulative_drift"

  continuity_recovery:
    primary: "continuity_f1"
    formula: "F1({A_recovered}, {A_original})"
    threshold: 0.85

    secondary:
      - "semantic_fidelity (cosine_similarity)"
      - "version_completeness"
      - "recovery_time"

reporting:
  output_format: "drift metrics report (YAML/JSON)"

  report_fields:
    - "test_id and name"
    - "invariant tested"
    - "pass/fail status"
    - "drift_norm (INV_001) or continuity_f1 (INV_007)"
    - "threshold and margin"
    - "execution timestamp"

  summary_metrics:
    - "mean drift_norm across INV_001 tests"
    - "mean continuity_f1 across INV_007 tests"
    - "pass rate per invariant"
    - "overall pass rate"

visualization:
  drift_plots:
    - "drift_norm over time (trajectory)"
    - "cumulative drift accumulation"
    - "forward-backward error distribution"

  continuity_plots:
    - "F1 score across reset cycles"
    - "semantic fidelity heatmap"
    - "recovery success rate by anchor type"

integration:
  combined_with: "invariants_suite.yaml"
  total_tests: 51

  full_validation:
    - "23 invariant tests (invariants_suite.yaml)"
    - "28 drift tests (this file)"
    - "All 8 invariants covered"

related_documents:
  invariants: "evolution_chamber/IRM/schema/invariants.yaml"
  other_tests: "evolution_chamber/IRM/tests/invariants_suite.yaml"
  pipeline: "testfield/protocols/IRM_Pipeline.yaml"

notes: >
  Drift checks are critical for validating IRM's temporal coherence and
  continuity guarantees. These 28 tests ensure state transitions remain
  reversible and that system genuinely maintains continuity vs. regenerating
  plausible-but-disconnected states.

  Combined with invariants_suite.yaml, this provides comprehensive 51-test
  validation of all 8 core IRM invariants. This is the quality gate for
  production deployment.
